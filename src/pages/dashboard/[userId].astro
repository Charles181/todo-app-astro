---
import Layout from "../../layouts/Layout.astro";
import { db, Users, Tasks, Requests, eq } from "astro:db";
import { sendDiscordNotification } from "../../utils/discord";

const res = await fetch("https://www.positive-api.online/phrase/esp");
const data = await res.json();
const phrase = data.text;

const { userId } = Astro.params;

if (!userId) {
	return Astro.redirect("/");
}

const currentUser = Astro.locals.user;
if (!currentUser) return Astro.redirect("/login");

// Security Check: Only allow access if it's your dashboard OR you are an admin
if (currentUser.id !== userId && currentUser.role !== "admin") {
	return Astro.redirect(`/dashboard/${currentUser.id}`);
}

// Fetch User Data Early for Notifications
const user = (await db.select().from(Users).where(eq(Users.id, userId))).at(0);

if (!user) {
	return Astro.redirect("/");
}

// Handle Form Submission
if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();
	const action = formData.get("action");

	if (action === "complete_task") {
		const taskId = formData.get("taskId");
		if (taskId) {
			// Get Task details for notification
			const task = (
				await db
					.select()
					.from(Tasks)
					.where(eq(Tasks.id, Number(taskId)))
			).at(0);

			await db
				.update(Tasks)
				.set({ status: "completed" })
				.where(eq(Tasks.id, Number(taskId)));

			if (task) {
				await sendDiscordNotification({
					type: "TASK_COMPLETED",
					user: { name: user.name },
					task: { title: task.title },
				});
			}
		}
	} else if (action === "request_supply") {
		const title = formData.get("title") as string;
		const description = formData.get("description") as string;
		if (title) {
			await db.insert(Requests).values({
				title,
				description,
				requesterId: userId,
				status: "pending",
				createdAt: new Date(),
			});

			await sendDiscordNotification({
				type: "MATERIAL_REQUEST",
				user: { name: user.name },
				request: { item: title, details: description },
			});
		}
	} else if (action === "add_homework") {
		const title = formData.get("title") as string;
		const description = formData.get("description") as string;
		const dueDateStr = formData.get("dueDate") as string;
		let dueDate: Date;
		if (dueDateStr) {
			const [year, month, day] = dueDateStr.split("-").map(Number);
			dueDate = new Date(year, month - 1, day);
		} else {
			dueDate = new Date();
		}

		if (title) {
			await db.insert(Tasks).values({
				title,
				description,
				assigneeId: userId,
				status: "pending",
				points: 10,
				dueDate: dueDate,
				assignedDate: new Date(),
			});

			await sendDiscordNotification({
				type: "NEW_TASK", // You might want to create a specific type for this (utils/discord.ts) , but NEW_TASK works
				user: { name: user.name },
				task: { title: `${title} (Autocreada)` },
			});
		}
	}
}

const allTasks = await db
	.select()
	.from(Tasks)
	.where(eq(Tasks.assigneeId, userId));
const pendingTasks = allTasks.filter((t) => t.status === "pending");
const completedTasks = allTasks.filter((t) => t.status === "completed");
const verifiedTasks = allTasks.filter((t) => t.status === "verified");

const myRequests = await db
	.select()
	.from(Requests)
	.where(eq(Requests.requesterId, userId));

// Calculate potential points
const potentialPoints = completedTasks.reduce((acc, t) => acc + t.points, 0);
---

<Layout title={`Dashboard de ${user.name}`}>
	<header
		class="mb-8 flex items-center justify-between bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 transition-colors"
	>
		<div class="flex items-center gap-4">
			<div class="text-6xl">{user.avatar || "ğŸ˜"}</div>
			<div>
				<h1
					class="text-3xl font-extrabold text-slate-800 dark:text-white"
				>
					Hola, {user.name}!
				</h1>
				<p class="text-slate-500 dark:text-slate-400">
					Â¡A completar tareas!
				</p>
			</div>
		</div>
		<div class="text-right">
			<div
				class="text-xs text-slate-400 font-bold uppercase tracking-widest"
			>
				Tus Puntos
			</div>
			<div class="text-5xl font-black text-amber-500">
				{user.score} â­
			</div>
			{
				potentialPoints > 0 && (
					<div class="text-sm text-slate-400 mt-1">
						+{potentialPoints} en revisiÃ³n
					</div>
				)
			}
		</div>
	</header>

	<div class="space-y-12">
		<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
			{/* Main Content: Tasks */}
			<div class="lg:col-span-2 space-y-12">
				{/* Pending Tasks */}
				<section>
					<h2
						class="text-2xl font-bold text-slate-700 dark:text-white mb-6 flex items-center gap-2"
					>
						ğŸ“ Por hacer
						<span
							class="bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 text-sm px-3 py-1 rounded-full"
							>{pendingTasks.length}</span
						>
					</h2>

					{
						pendingTasks.length === 0 ? (
							<div class="bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 rounded-xl p-8 text-center text-indigo-800 dark:text-indigo-200">
								Â¡Genial! No tienes tareas pendientes. ğŸ‰
							</div>
						) : (
							<div class="grid grid-cols-1 gap-6">
								{pendingTasks.map((task) => (
									<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden hover:shadow-lg transition-all flex flex-col sm:flex-row h-full">
										<div class="p-6 flex-1">
											<div class="flex justify-between items-start mb-4">
												<span class="bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 text-xs font-bold px-2 py-1 rounded uppercase">
													{task.points} Puntos
												</span>
												<div class="flex flex-col items-end gap-1">
													{task.assignedDate && (
														<span
															class="text-xs text-slate-400"
															title="Fecha de asignaciÃ³n"
														>
															ğŸ“¥{" "}
															{new Date(
																task.assignedDate,
															).toLocaleDateString()}
														</span>
													)}
													{task.dueDate && (
														<span
															class="text-xs text-slate-500 dark:text-slate-400"
															title="Fecha de vencimiento"
														>
															ğŸ“…{" "}
															{new Date(
																task.dueDate,
															).toLocaleDateString()}
														</span>
													)}
												</div>
											</div>
											<h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">
												{task.title}
											</h3>
											{task.description && (
												<p class="text-slate-600 dark:text-slate-300 mb-4">
													{task.description}
												</p>
											)}
										</div>
										<div class="p-4 bg-slate-50 dark:bg-slate-700/50 border-t sm:border-t-0 sm:border-l border-slate-100 dark:border-slate-700 flex items-center justify-center min-w-[150px]">
											<form method="POST">
												<input
													type="hidden"
													name="action"
													value="complete_task"
												/>
												<input
													type="hidden"
													name="taskId"
													value={task.id}
												/>
												<button
													type="submit"
													class="w-full sm:w-auto bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-emerald-200 shadow-md transition-all active:scale-95 flex items-center justify-center gap-2"
												>
													âœ… Â¡Lista!
												</button>
											</form>
										</div>
									</div>
								))}
							</div>
						)
					}
				</section>

				{/* Completed / Waiting for Review */}
				{
					(completedTasks.length > 0 || verifiedTasks.length > 0) && (
						<section class="opacity-80">
							<h2 class="text-xl font-bold text-slate-500 dark:text-slate-400 mb-6 border-t border-slate-200 dark:border-slate-700 pt-8">
								Historial y Revisiones
							</h2>
							<div class="space-y-4">
								{completedTasks.map((task) => (
									<div class="bg-slate-50 dark:bg-slate-800 rounded-xl p-4 flex items-center justify-between border border-slate-200 dark:border-slate-700 ml-4 border-l-4 border-l-amber-400">
										<div class="flex items-center gap-4">
											<span class="text-2xl opacity-50">
												â³
											</span>
											<div>
												<div class="font-bold text-slate-700 dark:text-slate-300 line-through decoration-slate-400">
													{task.title}
												</div>
												<div class="text-sm text-amber-600 dark:text-amber-500 font-medium">
													Esperando confirmaciÃ³n de
													papÃ¡s...
												</div>
											</div>
										</div>
										<div class="font-bold text-slate-400">
											+{task.points} pts
										</div>
									</div>
								))}

								{verifiedTasks.map((task) => (
									<div class="bg-slate-50 dark:bg-slate-800 rounded-xl p-4 flex items-center justify-between border border-slate-200 dark:border-slate-700 ml-4 border-l-4 border-l-green-400 opacity-60">
										<div class="flex items-center gap-4">
											<span class="text-2xl">ğŸ†</span>
											<div>
												<div class="font-bold text-slate-700 dark:text-slate-300 line-through decoration-slate-400">
													{task.title}
												</div>
												<div class="text-sm text-green-600 dark:text-green-500 font-medium">
													Â¡Completado!
												</div>
											</div>
										</div>
										<div class="font-bold text-green-600 dark:text-green-500">
											+{task.points} pts
										</div>
									</div>
								))}
							</div>
						</section>
					)
				}
			</div>

			{/* Sidebar: Requests & Other Tools */}
			<div class="space-y-8">
				{/* Add Homework Form */}
				<div
					class="bg-white dark:bg-slate-800 rounded-2xl shadow-md border border-slate-100 dark:border-slate-700 p-6"
				>
					<h2
						class="text-xl font-bold text-indigo-800 dark:text-indigo-400 mb-4"
					>
						ğŸ“š Agregar Tarea Escolar
					</h2>
					<form method="POST" class="space-y-4">
						<input
							type="hidden"
							name="action"
							value="add_homework"
						/>
						<div>
							<input
								type="text"
								name="title"
								required
								placeholder="Ej. Tarea de espaÃ±ol"
								class="w-full rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
							/>
						</div>
						<div>
							<textarea
								name="description"
								rows="2"
								placeholder="ResÃºmen de pÃ¡gina 16"
								class="w-full rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
							></textarea>
						</div>
						<div>
							<label class="text-xs text-slate-500 mb-1 block">
								Fecha de entrega
							</label>
							<input
								type="date"
								name="dueDate"
								required
								value={new Date().toISOString().split("T")[0]}
								class="w-full rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
							/>
						</div>
						<button
							type="submit"
							class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-xl transition shadow active:scale-95"
						>
							Guardar Tarea
						</button>
					</form>
				</div>

				{/* Request Form */}
				<div
					class="bg-white dark:bg-slate-800 rounded-2xl shadow-md border border-slate-100 dark:border-slate-700 p-6"
				>
					<h2
						class="text-xl font-bold text-indigo-800 dark:text-indigo-400 mb-4"
					>
						ğŸ“¢ Solicitar Material
					</h2>
					<p class="text-sm text-slate-500 mb-4">
						Â¿Necesitas algo para la escuela o la casa?
					</p>

					<form method="POST" class="space-y-4">
						<input
							type="hidden"
							name="action"
							value="request_supply"
						/>
						<div>
							<input
								type="text"
								name="title"
								required
								placeholder="Â¿QuÃ© necesitas?"
								class="w-full rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
							/>
						</div>
						<div>
							<textarea
								name="description"
								rows="2"
								placeholder="Detalles (opcional)"
								class="w-full rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
							></textarea>
						</div>
						<button
							type="submit"
							class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-xl transition shadow active:scale-95"
						>
							Enviar Solicitud
						</button>
					</form>
				</div>

				{/* My Requests List */}
				<section>
					<h3
						class="font-bold text-slate-600 dark:text-slate-400 mb-3 uppercase text-xs tracking-wider"
					>
						Mis Solicitudes
					</h3>
					<div class="space-y-3">
						{
							myRequests.length === 0 ? (
								<p class="text-sm text-slate-400 italic">
									No tienes solicitudes pendientes.
								</p>
							) : (
								myRequests.map((req) => (
									<div class="bg-white dark:bg-slate-800 p-3 rounded-lg border border-slate-100 dark:border-slate-700 text-sm shadow-sm relative overflow-hidden">
										<div
											class={`absolute left-0 top-0 bottom-0 w-1 ${
												req.status === "approved"
													? "bg-green-500"
													: req.status === "rejected"
														? "bg-red-500"
														: "bg-amber-400"
											}`}
										/>
										<div class="font-bold text-slate-800 dark:text-white pl-2">
											{req.title}
										</div>
										<div class="flex justify-between items-center mt-1 pl-2">
											<span
												class={`text-xs font-bold px-2 py-0.5 rounded-full ${
													req.status === "approved"
														? "bg-green-100 text-green-700"
														: req.status ===
															  "rejected"
															? "bg-red-100 text-red-700"
															: "bg-amber-100 text-amber-700"
												}`}
											>
												{req.status === "approved"
													? "Aprobado"
													: req.status === "rejected"
														? "Rechazado"
														: "Pendiente"}
											</span>
											<div class="text-xs text-slate-400">
												{req.createdAt
													? new Date(
															req.createdAt,
														).toLocaleDateString()
													: ""}
											</div>
										</div>
									</div>
								))
							)
						}
					</div>
				</section>
			</div>
		</div>
		<section>
			<h2
				class="text-center italic text-xl font-bold text-slate-500 dark:text-white mb-6 border-t border-slate-200 dark:border-slate-700 pt-8"
			>
				{phrase}
			</h2>
		</section>
	</div>
</Layout>
