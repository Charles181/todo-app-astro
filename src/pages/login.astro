---
import Layout from "../layouts/Layout.astro";
import { db, Users, Sessions, eq } from "astro:db";

if (Astro.locals.user) {
    return Astro.redirect("/");
}

let error = "";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const userId = formData.get("username") as string;
    const password = formData.get("password") as string;

    const user = (await db.select().from(Users).where(eq(Users.id, userId))).at(
        0,
    );

    if (user && user.password === password) {
        // Create Session
        const sessionToken = crypto.randomUUID();
        const expiresAt = Date.now() + 1000 * 60 * 60 * 24 * 7; // 1 week

        await db.insert(Sessions).values({
            id: sessionToken,
            userId: user.id,
            expiresAt,
        });

        Astro.cookies.set("session-id", sessionToken, {
            path: "/",
            httpOnly: true,
            secure: import.meta.env.PROD,
            sameSite: "lax",
            alert: new Date(expiresAt),
        });

        if (user.role === "admin") {
            return Astro.redirect("/admin");
        } else {
            return Astro.redirect(`/dashboard/${user.id}`);
        }
    } else {
        error = "Usuario o contraseña incorrectos";
    }
}
---

<Layout title="Iniciar Sesión">
    <div class="flex items-center justify-center min-h-[70vh]">
        <div
            class="bg-[url(/robloxwp.jpg)] bg-cover bg-center p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-100"
        >
            <div class="text-center mb-8">
                <h1 class="text-3xl font-extrabold text-red-500">Ayudapp</h1>
                <p class="text-black">Inicia sesión para continuar</p>
            </div>

            {
                error && (
                    <div class="bg-red-50 text-red-600 p-4 rounded-lg mb-6 text-sm text-center border border-red-100">
                        {error}
                    </div>
                )
            }

            <form method="POST" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-white mb-2"
                        >Usuario</label
                    >
                    <input
                        type="text"
                        name="username"
                        required
                        class="w-full px-4 py-3 rounded-lg border border-slate-300 bg-white text-slate-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition outline-none"
                        style="color: #0f172a;"
                        placeholder="Ej. admin o nombre"
                    />
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2"
                        >Contraseña</label
                    >
                    <input
                        type="password"
                        name="password"
                        required
                        class="w-full px-4 py-3 rounded-lg border border-slate-300 bg-white text-slate-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition outline-none"
                        style="color: #0f172a;"
                        placeholder="••••••••"
                    />
                </div>

                <button
                    type="submit"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-indigo-200 active:scale-95"
                >
                    Entrar
                </button>
            </form>
        </div>
    </div>
</Layout>
